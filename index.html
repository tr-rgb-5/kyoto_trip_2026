<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>京都旅路 Kyoto Trip</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        /* --- 根據您的圖片提取的配色 --- */
                        
                        // 1. 深紅色 (最左邊)
                        'color-brick-red': '#9A3334', 
                        
                        // 2. 深炭灰 (左二) - 用於主要文字、深色按鈕
                        'color-dark-brown': '#363636', 
                        
                        // 3. 卡其米色 (中間) - 用於按鈕背景、強調色
                        'color-medium-sand': '#C5BAA9', 
                        
                        // 3-1. 淺米色 (中間色的淺色版) - 用於輸入框背景、卡片底色
                        'color-light-cream': '#EBE6DC', 

                        // 4. 冷灰色 (右二) - 用於次要文字、邊框
                        'color-cool-grey': '#8D9092',

                        // 5. 橄欖褐 (最右邊) - 用於次要強調
                        'color-grey-brown': '#8C8A74',
                        
                        
                        /* --- 功能性別名設定 --- */
                        'theme-main': '#363636',   // 主色調 (深色)
                        'theme-accent': '#9A3334', // 強調色 (紅色)
                        'theme-base-light': '#F5F3EF', // 網頁背景 (極淺米灰)
                        'theme-secondary': '#8C8A74', // 次要色
                    },
                    fontFamily: {
                        sans: ['"Hiragino Kaku Gothic ProN"', '"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* 整體背景色調整 */
        body { background-color: #F5F3EF; color: #363636; -webkit-tap-highlight-color: transparent; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #map { height: 100%; width: 100%; border-radius: 1rem; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .timeline-line {
            position: absolute;
            left: 15px; 
            top: 24px;
            bottom: -24px;
            width: 2px;
            /* 線條顏色改為新的深紅色 */
            background-color: #9A3334;
            z-index: 0;
            opacity: 0.6;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="app" class="h-full flex flex-col relative">

        <header class="pt-6 pb-2 px-4 bg-theme-base-light shadow-sm z-20 border-b border-color-medium-sand/30 relative">
            <h1 class="text-xl font-bold mb-4 tracking-widest text-center text-color-brick-red flex items-center justify-center">
                <i class="fa-solid fa-torii-gate mr-2"></i>京都旅路
            </h1>
            
            <button @click="openSwapModal" class="absolute right-4 top-6 text-color-grey-brown hover:text-color-brick-red text-xs flex items-center bg-white/60 px-2 py-1 rounded-full shadow-sm border border-color-medium-sand/20">
                <i class="fa-solid fa-right-left mr-1"></i>行程對調
            </button>

            <div class="flex space-x-3 overflow-x-auto hide-scrollbar pb-2 px-1">
                <div v-for="date in dates" :key="date.val" 
                     @click="selectDate(date.val)"
                     class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-lg transition-all duration-300 border cursor-pointer"
                     :class="selectedDate === date.val ? 'bg-color-brick-red text-white shadow-md transform scale-105 border-color-brick-red' : 'bg-white text-color-grey-brown border-color-medium-sand/30'">
                    <span class="text-xs font-light">{{ date.day }}</span>
                    <span class="text-lg font-bold">{{ date.date }}</span>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-24 relative bg-theme-base-light">
            
            <transition name="fade" mode="out-in">
                <div v-if="currentTab === 'schedule'" class="space-y-0 relative pb-10">
                    <div class="flex justify-between items-center mb-4 pl-1">
                        <h2 class="text-lg font-bold text-theme-main">本日行程</h2>
                        <button @click="openModal" class="text-xs bg-color-medium-sand px-3 py-1.5 rounded-full text-white shadow-sm hover:bg-opacity-90">
                            <i class="fa-solid fa-plus mr-1"></i>新增
                        </button>
                    </div>

                    <div class="relative pl-2">
                        <div v-if="todayItinerary.length === 0" class="text-center py-10 text-color-grey-brown/60 text-sm">
                            本日尚無行程，點擊右上角新增
                        </div>

                        <div v-for="(item, index) in todayItinerary" :key="index" class="relative mb-0 group">
                            
                            <div v-if="index < todayItinerary.length - 1" class="timeline-line"></div>

                            <div class="flex gap-4 relative z-10 mb-2">
                                <div class="flex flex-col items-center min-w-[32px] pt-4">
                                    <div class="w-3 h-3 rounded-full border-2 border-theme-base-light shadow-sm ring-2 ring-opacity-50 bg-white" 
                                         :class="getCategoryRing(item.category)"></div>
                                </div>

                                <div class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-color-medium-sand/20 relative transition-all duration-300"
                                     :class="{'ring-2 ring-color-brick-red ring-opacity-20': item.isEditing}">
                                    
                                    <button @click="toggleEdit(item)" class="absolute top-4 right-4 text-color-grey-brown/60 hover:text-color-brick-red transition-colors z-20">
                                        <i class="fa-solid" :class="item.isEditing ? 'fa-check text-green-600' : 'fa-pen'"></i>
                                    </button>

                                    <div class="flex flex-wrap items-baseline gap-2 mb-2 pr-8">
                                        <div v-if="item.isEditing" class="w-full space-y-2 mb-2">
                                            <div class="flex gap-2">
                                                <select @change="changeItemDate(item, index, $event)" class="bg-color-light-cream border border-color-medium-sand/30 rounded px-2 py-1 text-sm font-bold text-color-grey-brown">
                                                    <option v-for="d in dates" :key="d.val" :value="d.val" :selected="d.val === selectedDate">{{ d.val }}</option>
                                                </select>
                                                <input type="time" v-model="item.time" class="bg-color-light-cream border border-color-medium-sand/30 rounded px-2 py-1 text-sm font-bold text-color-brick-red">
                                            </div>
                                            <input type="text" v-model="item.location" class="w-full bg-color-light-cream border border-color-medium-sand/30 rounded px-2 py-1 text-sm font-bold text-theme-main">
                                        </div>
                                        <template v-else>
                                            <span class="text-lg font-bold text-color-brick-red font-mono">{{ item.time }}</span>
                                            <h3 class="text-base font-bold text-theme-main">{{ item.location }}</h3>
                                        </template>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div v-if="item.isEditing">
                                            <input type="text" v-model="item.note" placeholder="備註..." class="w-full bg-color-light-cream border border-color-medium-sand/30 rounded px-2 py-1 text-xs text-color-grey-brown">
                                        </div>
                                        <p v-else-if="item.note" class="text-color-grey-brown text-xs flex items-start">
                                            <i class="fa-solid fa-location-arrow text-color-brick-red mt-0.5 mr-2 text-[10px] transform rotate-45"></i>
                                            {{ item.note }}
                                        </p>
                                    </div>

                                    <div class="flex justify-between items-center pt-2 border-t border-color-light-cream">
                                        <span :class="getCategoryClass(item.category)" class="text-[10px] px-2 py-0.5 rounded-md font-medium border border-transparent">
                                            {{ getCategoryLabel(item.category) }}
                                        </span>
                                        <div class="flex gap-3">
                                            <a :href="getGoogleMapLink(item.location)" target="_blank" 
                                               class="text-[10px] text-color-grey-brown/80 hover:text-color-brick-red flex items-center transition-colors">
                                                <i class="fa-solid fa-map-location-dot mr-1"></i>Map
                                            </a>
                                            <button v-if="item.isEditing" @click="deleteItem(index)" class="text-[10px] text-color-brick-red hover:underline flex items-center">
                                                <i class="fa-solid fa-trash mr-1"></i>刪除
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="index < todayItinerary.length - 1" class="pl-[48px] mb-2 relative z-10">
                                <div class="bg-color-light-cream/60 rounded-lg border border-color-medium-sand/10 overflow-hidden transition-all duration-300">
                                    <button @click="item.showTransport = !item.showTransport" 
                                            class="w-full text-left px-3 py-2 text-xs font-bold text-color-dark-brown flex justify-between items-center hover:bg-color-medium-sand/20 transition-colors">
                                            <span>
                                                <i class="fa-solid fa-shoe-prints mr-2 text-color-grey-brown/60"></i>
                                                交通
                                                <span v-if="item.transportDetail && !item.showTransport" class="ml-2 font-normal text-color-grey-brown/60 text-[10px] truncate max-w-[120px] inline-block align-bottom">
                                                    ({{ item.transportDetail }})
                                                </span>
                                            </span>
                                            <i class="fa-solid text-[10px]" :class="item.showTransport ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                    </button>
                                    
                                    <div v-if="item.showTransport" class="p-2 bg-white/50 border-t border-color-medium-sand/10">
                                        <textarea v-model="item.transportDetail" 
                                                  placeholder="輸入交通方式..."
                                                  class="w-full text-xs text-theme-main bg-color-light-cream p-2 rounded focus:outline-none focus:ring-1 focus:ring-color-brick-red resize-none h-20 leading-relaxed border border-color-medium-sand/10"></textarea>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </transition>

            <div v-show="currentTab === 'map'" class="h-full w-full relative">
                <div id="map" class="shadow-inner border border-color-medium-sand/30"></div>
                <button @click="locateMe" class="absolute bottom-4 right-4 bg-white w-10 h-10 rounded-full shadow-lg z-[400] flex items-center justify-center text-theme-main hover:text-color-brick-red transition-colors">
                    <i class="fa-solid fa-crosshairs"></i>
                </button>
            </div>

            <transition name="fade" mode="out-in">
                <div v-if="currentTab === 'money'" class="space-y-4">
                    <div class="flex justify-end mb-2">
                        <button @click="toggleRateSettings" class="text-[10px] text-color-grey-brown underline">
                            匯率: {{ exchangeRate }} (點擊修改)
                        </button>
                    </div>
                    <div v-if="showRateSettings" class="bg-color-medium-sand/30 p-2 rounded mb-2 flex items-center gap-2">
                        <label class="text-xs text-color-dark-brown">1 JPY =</label>
                        <input type="number" v-model="exchangeRate" step="0.001" class="w-16 bg-white border rounded px-1 text-sm text-center">
                        <span class="text-xs text-color-dark-brown">TWD</span>
                    </div>

                    <div class="flex justify-between items-end mb-1 px-1">
                        <h2 class="text-lg font-bold text-theme-main">本日消費 <span class="text-sm text-color-grey-brown font-normal">({{ selectedDate }})</span></h2>
                    </div>

                    <form @submit.prevent="addExpense" class="flex gap-2 mb-4 bg-white p-3 rounded-xl shadow-sm border border-color-medium-sand/20 items-center">
                        <input type="text" v-model="newExpenseName" placeholder="品項 (如: 拉麵)" class="flex-1 bg-transparent px-2 text-sm focus:outline-none text-theme-main min-w-0 placeholder-color-medium-sand">
                        
                        <div class="w-px h-6 bg-color-medium-sand/30 mx-1"></div>
                        
                        <div class="flex items-center">
                            <input type="number" v-model="newExpenseAmount" placeholder="金額" class="w-20 bg-transparent px-2 text-sm focus:outline-none text-theme-main text-right placeholder-color-medium-sand">
                            <button type="button" @click="toggleCurrency" class="ml-1 px-2 py-1 bg-color-medium-sand/30 text-color-grey-brown text-[10px] font-bold rounded hover:bg-color-grey-brown hover:text-white transition-colors flex-shrink-0">
                                {{ inputCurrency }}
                            </button>
                        </div>

                        <button type="submit" class="bg-color-brick-red text-white w-10 h-10 rounded-lg shadow-sm flex items-center justify-center flex-shrink-0 ml-2 active:scale-95 transition-transform hover:bg-opacity-90">
                            <i class="fa-solid fa-plus text-sm"></i>
                        </button>
                    </form>

                    <div class="space-y-2 pb-20">
                        <div v-if="dailyExpenses.length === 0" class="text-center py-8 text-color-grey-brown/40 text-xs">
                            還沒有消費紀錄，試著新增一筆吧！
                        </div>
                        <div v-for="(exp, idx) in dailyExpenses" :key="exp.id" class="bg-white px-4 py-3 rounded-xl shadow-sm border border-color-medium-sand/20 flex justify-between items-center group hover:border-color-medium-sand/40 transition-colors">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <div class="w-8 h-8 rounded-full bg-color-medium-sand/20 flex items-center justify-center text-color-grey-brown text-xs flex-shrink-0">
                                    <i class="fa-solid fa-receipt"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <input v-if="exp.isEditing" v-model="exp.item" class="font-bold text-sm text-theme-main bg-color-light-cream w-full px-1 rounded" @blur="exp.isEditing = false">
                                    <p v-else @click="exp.isEditing = true" class="font-bold text-sm text-theme-main cursor-pointer truncate">{{ exp.item }}</p>
                                </div>
                            </div>
                            <div class="text-right pl-4 flex-shrink-0">
                                <div v-if="exp.isEditing">
                                    <input type="number" v-model="exp.jpy" class="font-bold text-theme-main text-sm text-right bg-color-light-cream w-20 px-1 rounded" @blur="exp.isEditing = false">
                                </div>
                                <div v-else @click="exp.isEditing = true" class="cursor-pointer">
                                    <p class="font-bold text-theme-main text-sm">¥{{ formatCurrency(exp.jpy) }}</p>
                                    <p class="text-[10px] text-color-grey-brown">≈ NT${{ formatCurrency(Math.round(exp.jpy * exchangeRate)) }}</p>
                                </div>
                            </div>
                            <button @click="deleteExpense(exp.id)" class="ml-3 text-color-grey-brown/30 hover:text-color-brick-red flex-shrink-0">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mt-8 border-t border-dashed border-color-medium-sand/40 pt-4 text-center">
                        <p class="text-xs text-color-grey-brown uppercase tracking-widest mb-1">Total Trip Expenses</p>
                        <p class="text-xl font-bold text-theme-main">
                            NT$ {{ formatCurrency(tripTotal) }} 
                            <span class="text-xs font-normal text-color-grey-brown/70 ml-2">(¥{{ formatCurrency(Math.round(tripTotal/exchangeRate)) }})</span>
                        </p>
                    </div>
                </div>
            </transition>
        </main>

        <nav class="fixed bottom-0 w-full bg-[#F5F3EF]/95 backdrop-blur-md border-t border-color-medium-sand/20 pb-safe pt-2 px-6 flex justify-between z-30 shadow-lg">
            <button @click="switchTab('schedule')" class="flex flex-col items-center p-2 w-16 transition-colors" :class="currentTab === 'schedule' ? 'text-color-brick-red' : 'text-color-grey-brown/70 hover:text-color-dark-brown'">
                <i class="fa-solid fa-calendar-day text-lg mb-1"></i><span class="text-[10px] font-medium">行程</span>
            </button>
            <button @click="switchTab('map')" class="flex flex-col items-center p-2 w-16 transition-colors" :class="currentTab === 'map' ? 'text-color-brick-red' : 'text-color-grey-brown/70 hover:text-color-dark-brown'">
                <i class="fa-solid fa-map text-lg mb-1"></i><span class="text-[10px] font-medium">地圖</span>
            </button>
            <button @click="switchTab('money')" class="flex flex-col items-center p-2 w-16 transition-colors" :class="currentTab === 'money' ? 'text-color-brick-red' : 'text-color-grey-brown/70 hover:text-color-dark-brown'">
                <i class="fa-solid fa-yen-sign text-lg mb-1"></i><span class="text-[10px] font-medium">記帳</span>
            </button>
        </nav>

        <div v-if="showModal" class="fixed inset-0 bg-theme-main/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl border border-color-medium-sand/20">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-theme-main">新增行程</h3>
                    <button @click="showModal = false"><i class="fa-solid fa-xmark text-color-grey-brown hover:text-color-brick-red"></i></button>
                </div>
                <div class="space-y-3">
                    <div class="bg-color-light-cream rounded-xl px-3 py-2 border border-color-medium-sand/20">
                        <label class="text-[10px] text-color-grey-brown font-bold uppercase">Time</label>
                        <input v-model="newItem.time" type="time" class="w-full bg-transparent font-bold text-theme-main focus:outline-none">
                    </div>
                    <div class="bg-color-light-cream rounded-xl px-3 py-2 border border-color-medium-sand/20">
                        <label class="text-[10px] text-color-grey-brown font-bold uppercase">Location</label>
                        <input v-model="newItem.location" type="text" placeholder="地點" class="w-full bg-transparent text-sm focus:outline-none text-theme-main placeholder-color-medium-sand">
                    </div>
                    
                    <div class="bg-color-light-cream rounded-xl px-3 py-2 border border-color-medium-sand/20">
                        <label class="text-[10px] text-color-grey-brown font-bold uppercase">Category</label>
                        <div class="flex gap-2 mt-2 overflow-x-auto hide-scrollbar">
                            <button v-for="cat in categories" :key="cat.value" 
                                @click="newItem.category = cat.value"
                                class="px-3 py-1.5 rounded-lg text-xs font-medium transition-colors border"
                                :class="newItem.category === cat.value ? 'bg-color-dark-brown text-white border-color-dark-brown' : 'bg-white text-color-grey-brown border-color-medium-sand/30 hover:border-color-grey-brown'">
                                {{ cat.label }}
                            </button>
                        </div>
                    </div>

                    <div class="bg-color-light-cream rounded-xl px-3 py-2 border border-color-medium-sand/20">
                        <label class="text-[10px] text-color-grey-brown font-bold uppercase">Note</label>
                        <input v-model="newItem.note" type="text" placeholder="備註" class="w-full bg-transparent text-sm focus:outline-none text-theme-main placeholder-color-medium-sand">
                    </div>
                    <div class="bg-color-light-cream rounded-xl px-3 py-2 border border-color-medium-sand/20">
                        <label class="text-[10px] text-color-grey-brown font-bold uppercase">下一段交通 (可選)</label>
                        <textarea v-model="newItem.transportDetail" placeholder="例如：搭公車 205 號..." class="w-full bg-transparent text-sm focus:outline-none h-16 resize-none mt-1 text-theme-main placeholder-color-medium-sand"></textarea>
                    </div>
                </div>
                <button @click="addItem" class="mt-6 w-full bg-color-brick-red text-white rounded-xl py-3.5 font-bold shadow-lg hover:bg-opacity-90 transition-colors">確認</button>
            </div>
        </div>

        <div v-if="showSwapModal" class="fixed inset-0 bg-theme-main/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center border border-color-medium-sand/20">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-theme-main">行程整日對調</h3>
                    <button @click="showSwapModal = false"><i class="fa-solid fa-xmark text-color-grey-brown hover:text-color-brick-red"></i></button>
                </div>
                <p class="text-xs text-color-grey-brown mb-4">適合因天氣變化需要更改行程順序時使用</p>
                
                <div class="flex justify-between items-center gap-2 mb-6">
                    <select v-model="swapDateA" class="bg-color-light-cream p-2 rounded text-sm font-bold w-1/2 text-theme-main border border-color-medium-sand/20">
                        <option v-for="d in dates" :key="d.val" :value="d.val">{{ d.val }}</option>
                    </select>
                    <i class="fa-solid fa-right-left text-color-brick-red"></i>
                    <select v-model="swapDateB" class="bg-color-light-cream p-2 rounded text-sm font-bold w-1/2 text-theme-main border border-color-medium-sand/20">
                        <option v-for="d in dates" :key="d.val" :value="d.val">{{ d.val }}</option>
                    </select>
                </div>

                <button @click="confirmSwap" class="w-full bg-color-brick-red text-white rounded-xl py-3.5 font-bold shadow-lg hover:bg-opacity-90 transition-colors">
                    確認對調
                </button>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, nextTick } = Vue;

        createApp({
            setup() {
                const currentTab = ref('schedule');
                const selectedDate = ref('1/8');
                const showModal = ref(false);
                const showSwapModal = ref(false);
                const mapInstance = ref(null);
                const markers = ref([]);
                const exchangeRate = ref(0.215); 
                const showRateSettings = ref(false);

                // Money
                const inputCurrency = ref('JPY'); 
                const newExpenseName = ref('');
                const newExpenseAmount = ref('');

                // Schedule
                const newItem = ref({ time: '09:00', location: '', note: '', category: 'sightseeing', transportDetail: '' });
                const swapDateA = ref('1/9');
                const swapDateB = ref('1/10');
                
                const dates = [
                    { val: '1/8', day: 'Thu', date: '08' },
                    { val: '1/9', day: 'Fri', date: '09' },
                    { val: '1/10', day: 'Sat', date: '10' },
                    { val: '1/11', day: 'Sun', date: '11' },
                ];
                
                const categories = [
                    { label: '景點', value: 'sightseeing' },
                    { label: '吃飯', value: 'dining' },
                    { label: '逛逛', value: 'shopping' },
                    { label: '移動', value: 'transport' },
                ];

                const itineraryData = ref({
                    '1/8': [
                        { time: '18:50', location: '桃園機場 T1', note: 'BR130 / MM028', category: 'transport', transportDetail: '飛機直飛關西機場', showTransport: false, isEditing: false, lat: 25.08, lng: 121.23 },
                        { time: '22:15', location: '關西機場 T2', note: '深夜抵達', category: 'transport', transportDetail: '搭乘 Haruka 特急列車往京都\n或者搭乘利木津巴士', showTransport: false, isEditing: false, lat: 34.43, lng: 135.23 },
                        { time: '23:30', location: '四條烏丸住宿', note: 'Check-in', category: 'sightseeing', transportDetail: '', showTransport: false, isEditing: false, lat: 35.00, lng: 135.75 }
                    ],
                    '1/9': [
                        { time: '09:00', location: '貴船神社', note: '水占卜 (若下雪很美)', category: 'sightseeing', transportDetail: '步行至貴船口站\n轉乘叡山電車', showTransport: false, isEditing: false, lat: 35.12, lng: 135.76 },
                        { time: '12:00', location: '貴船莊', note: '川床料理', category: 'dining', transportDetail: '搭乘叡山電車至出町柳站', showTransport: false, isEditing: false, lat: 35.11, lng: 135.76 },
                        { time: '14:30', location: '下鴨神社', note: '糺之森', category: 'sightseeing', transportDetail: '搭乘京都市巴士 4 號或 205 號\n至四條河原町', showTransport: false, isEditing: false, lat: 35.03, lng: 135.77 },
                        { time: '18:00', location: '祇園/河原町', note: '晚餐', category: 'shopping', transportDetail: '', showTransport: false, isEditing: false, lat: 35.00, lng: 135.77 }
                    ],
                    '1/10': [
                        { time: '07:30', location: '伏見稻荷大社', note: '千本鳥居', category: 'sightseeing', transportDetail: '搭乘 JR 奈良線返回京都車站\n轉乘 JR 京都線至大阪', showTransport: false, isEditing: false, lat: 34.96, lng: 135.77 },
                        { time: '13:00', location: '大阪梅田', note: '百貨公司', category: 'shopping', transportDetail: '搭乘御堂筋線至難波/心齋橋', showTransport: false, isEditing: false, lat: 34.70, lng: 135.49 },
                        { time: '18:00', location: '道頓堀', note: '大阪燒', category: 'dining', transportDetail: '搭乘京阪電車或 JR 返回京都', showTransport: false, isEditing: false, lat: 34.66, lng: 135.50 }
                    ],
                    '1/11': [
                        { time: '10:00', location: '錦市場', note: '伴手禮', category: 'shopping', transportDetail: '步行至地鐵四條站\n搭烏丸線至京都車站', showTransport: false, isEditing: false, lat: 35.00, lng: 135.76 },
                        { time: '12:00', location: '京都車站', note: 'Haruka', category: 'transport', transportDetail: '搭乘 Haruka 特急列車\n約 75 分鐘抵達機場', showTransport: false, isEditing: false, lat: 34.98, lng: 135.75 },
                        { time: '15:25', location: '關西機場', note: '回程', category: 'transport', transportDetail: '', showTransport: false, isEditing: false, lat: 34.43, lng: 135.23 }
                    ]
                });

                const expenses = ref([
                    { id: 1, date: '1/8', item: '機票 (示意)', jpy: 12000, isEditing: false },
                    { id: 2, date: '1/9', item: '貴船午餐', jpy: 3500, isEditing: false },
                ]);

                // Computed
                const todayItinerary = computed(() => itineraryData.value[selectedDate.value] || []);
                const dailyExpenses = computed(() => expenses.value.filter(e => e.date === selectedDate.value));
                const tripTotal = computed(() => {
                    let totalJpy = expenses.value.reduce((sum, item) => sum + Number(item.jpy), 0);
                    return Math.round(totalJpy * exchangeRate.value);
                });

                // Functions
                const selectDate = (date) => {
                    selectedDate.value = date;
                    if (currentTab.value === 'map') updateMapMarkers();
                };

                const switchTab = (tab) => {
                    currentTab.value = tab;
                    if (tab === 'map') nextTick(() => initMap());
                };

                const openModal = () => {
                    newItem.value = { time: '09:00', location: '', note: '', category: 'sightseeing', transportDetail: '' };
                    showModal.value = true;
                };
                const openSwapModal = () => showSwapModal.value = true;

                const confirmSwap = () => {
                    if (swapDateA.value === swapDateB.value) {
                        alert("請選擇不同的日期");
                        return;
                    }
                    const temp = itineraryData.value[swapDateA.value] || [];
                    itineraryData.value[swapDateA.value] = itineraryData.value[swapDateB.value] || [];
                    itineraryData.value[swapDateB.value] = temp;
                    
                    showSwapModal.value = false;
                    alert(`已完成 ${swapDateA.value} 與 ${swapDateB.value} 的行程對調！`);
                    
                    if (selectedDate.value === swapDateA.value || selectedDate.value === swapDateB.value) {
                        const current = selectedDate.value;
                        selectedDate.value = '';
                        nextTick(() => selectedDate.value = current);
                    }
                };

                const changeItemDate = (item, index, event) => {
                    const newDate = event.target.value;
                    if (newDate === selectedDate.value) return;

                    const itemToMove = itineraryData.value[selectedDate.value].splice(index, 1)[0];
                    if (!itineraryData.value[newDate]) itineraryData.value[newDate] = [];
                    itineraryData.value[newDate].push(itemToMove);
                    itineraryData.value[newDate].sort((a, b) => a.time.localeCompare(b.time));

                    item.isEditing = false;
                    alert(`已將行程移至 ${newDate}`);
                };

                const addItem = () => {
                    if (!newItem.value.location || !newItem.value.time || !newItem.value.category) {
                        alert("請輸入地點、時間與分類");
                        return;
                    }
                    if (!itineraryData.value[selectedDate.value]) itineraryData.value[selectedDate.value] = [];
                    itineraryData.value[selectedDate.value].push({
                        ...newItem.value,
                        isEditing: false, showTransport: false, lat: 35.00, lng: 135.75
                    });
                    itineraryData.value[selectedDate.value].sort((a, b) => a.time.localeCompare(b.time));
                    showModal.value = false;
                    newItem.value = { time: '09:00', location: '', note: '', category: 'sightseeing', transportDetail: '' };
                };

                const deleteItem = (idx) => {
                    if(confirm('刪除此行程？')) itineraryData.value[selectedDate.value].splice(idx, 1);
                };

                const toggleEdit = (item) => { item.isEditing = !item.isEditing; };

                // Money Logic
                const toggleCurrency = () => {
                    inputCurrency.value = inputCurrency.value === 'JPY' ? 'TWD' : 'JPY';
                };
                
                const toggleRateSettings = () => { showRateSettings.value = !showRateSettings.value; };

                const addExpense = () => {
                    if(!newExpenseName.value || !newExpenseAmount.value) {
                        alert('請輸入項目名稱和金額');
                        return;
                    }

                    let finalJpy = 0;
                    if (inputCurrency.value === 'JPY') {
                        finalJpy = Number(newExpenseAmount.value);
                    } else {
                        finalJpy = Math.round(Number(newExpenseAmount.value) / exchangeRate.value);
                    }
                    expenses.value.unshift({
                        id: Date.now(),
                        date: selectedDate.value,
                        item: newExpenseName.value,
                        jpy: finalJpy,
                        isEditing: false
                    });
                    newExpenseName.value = '';
                    newExpenseAmount.value = '';
                };

                const deleteExpense = (id) => {
                    if(confirm('刪除消費紀錄？')) expenses.value = expenses.value.filter(e => e.id !== id);
                };

                const formatCurrency = (val) => new Intl.NumberFormat().format(val);
                
                // Color Helper Functions (Updated Mappings)
                const getCategoryClass = (cat) => ({ 
                    sightseeing: 'bg-color-medium-sand/40 text-color-dark-brown', 
                    dining: 'bg-color-brick-red/20 text-color-brick-red', 
                    shopping: 'bg-color-grey-brown/30 text-color-dark-brown', 
                    transport: 'bg-gray-200 text-gray-600' 
                }[cat]);
                
                const getCategoryRing = (cat) => ({ 
                    sightseeing: 'ring-color-medium-sand', 
                    dining: 'ring-color-brick-red', 
                    shopping: 'ring-color-grey-brown', 
                    transport: 'ring-gray-400' 
                }[cat]);
                
                const getCategoryLabel = (cat) => ({ sightseeing: '景點', dining: '吃飯', shopping: '逛逛', transport: '移動' }[cat] || '其他');
                
                const getGoogleMapLink = (loc) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`;

                const initMap = () => {
                    if (!mapInstance.value) {
                        mapInstance.value = L.map('map').setView([35.0035, 135.7595], 13);
                        // Changed map style to a simpler one to match the clean aesthetic
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
                            attribution: '©OpenStreetMap, ©CartoDB',
                            subdomains: 'abcd',
                            maxZoom: 20
                        }).addTo(mapInstance.value);
                    } else mapInstance.value.invalidateSize();
                    updateMapMarkers();
                };

                const updateMapMarkers = () => {
                    if (!mapInstance.value) return;
                    markers.value.forEach(m => mapInstance.value.removeLayer(m));
                    markers.value = [];
                    const list = todayItinerary.value;
                    if (list.length > 0) {
                        const bounds = L.latLngBounds();
                        list.forEach(item => {
                            if (item.lat) {
                                const marker = L.marker([item.lat, item.lng]).addTo(mapInstance.value)
                                    .bindPopup(`<b>${item.time}</b> ${item.location}`);
                                markers.value.push(marker);
                                bounds.extend([item.lat, item.lng]);
                            }
                        });
                        mapInstance.value.fitBounds(bounds, { padding: [50, 50] });
                    }
                };
                
                const locateMe = () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(pos => {
                            mapInstance.value.setView([pos.coords.latitude, pos.coords.longitude], 15);
                            L.marker([pos.coords.latitude, pos.coords.longitude]).addTo(mapInstance.value).bindPopup('目前位置').openPopup();
                        });
                    }
                };

                return {
                    currentTab, selectedDate, dates, todayItinerary, showModal, newItem, categories,
                    expenses, newExpenseName, newExpenseAmount, tripTotal, dailyExpenses, 
                    exchangeRate, showRateSettings, inputCurrency, showSwapModal, swapDateA, swapDateB,
                    selectDate, switchTab, openModal, addItem, deleteItem, toggleEdit, addExpense, deleteExpense,
                    toggleCurrency, toggleRateSettings, openSwapModal, confirmSwap, changeItemDate,
                    formatCurrency, getCategoryClass, getCategoryRing, getCategoryLabel, getGoogleMapLink, locateMe
                };
            }
        }).mount('#app');
    </script>
</body>
</html>